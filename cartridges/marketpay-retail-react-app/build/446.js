"use strict";(self.__LOADABLE_LOADED_CHUNKS__=self.__LOADABLE_LOADED_CHUNKS__||[]).push([[446],{4997(t,e,n){n.d(e,{A:()=>p});var r=n(10939),i=n(28407),o=n(90031),s=n(77810),d=n(73448);function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}const p=t=>{const e=(0,o.useShopperBasketsMutation)("updateItemInBasket"),n=(0,o.useShopperBasketsMutation)("updateItemsInBasket"),p=(0,s.useCallback)(function(){var n=(0,i.A)(function*(n,r,i){if(!t||null==n||!n.itemId)throw new Error("Invalid basket or product item");const o={productId:n.productId,quantity:n.quantity,shipmentId:r,inventoryId:i};return yield e.mutateAsync({parameters:{basketId:t,itemId:n.itemId},body:o})});return function(t,e,r){return n.apply(this,arguments)}}(),[t,e]),a=(0,s.useCallback)(function(){var n=(0,i.A)(function*(n,r=d.zQ,i){if(!t||null==n||!n.itemId)throw new Error("Invalid basket or product item");const o={productId:n.productId,quantity:n.quantity,shipmentId:r};return n.inventoryId&&(o.inventoryId=i),yield e.mutateAsync({parameters:{basketId:t,itemId:n.itemId},body:o})});return function(t){return n.apply(this,arguments)}}(),[t,e]),l=(0,s.useCallback)(function(){var e=(0,i.A)(function*(e,i=d.zQ,o){if(!t||!Array.isArray(e))throw new Error("Invalid basket or product items array");if(0===e.length)return{updated:!0};const s=e.map(t=>function(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach(function(e){(0,r.A)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}({itemId:t.itemId,productId:t.productId,quantity:t.quantity,shipmentId:i},t.inventoryId&&{inventoryId:o}));return yield n.mutateAsync({parameters:{basketId:t},body:s})});return function(t){return e.apply(this,arguments)}}(),[t,n]),c=(0,s.useCallback)(function(){var e=(0,i.A)(function*(e,r,i){if(!t||!Array.isArray(e))throw new Error("Invalid basket or product items array");if(0===e.length)return{updated:!0};const o=e.map(t=>({itemId:t.itemId,productId:t.productId,quantity:t.quantity,shipmentId:r,inventoryId:i}));return yield n.mutateAsync({parameters:{basketId:t},body:o})});return function(t,n,r){return e.apply(this,arguments)}}(),[t,n]),h=(0,s.useCallback)(function(){var e=(0,i.A)(function*(e,n,r,i,o,s){if(!t||!e)throw new Error("Invalid basket or product item");if(n){var d;if(null==r||!r.id)throw new Error("No store selected for pickup");if(!r.inventoryId)throw new Error("Selected store does not have an inventory ID");const t=null===(d=yield o(r))||void 0===d?void 0:d.shipmentId;if(!t)throw new Error("Failed to find or create shipment");yield p(e,t,r.inventoryId)}else{var u;const t=null===(u=yield s())||void 0===u?void 0:u.shipmentId;if(!t)throw new Error("Failed to find or create shipment");yield a(e,t,i)}});return function(t,n,r,i,o,s){return e.apply(this,arguments)}}(),[t,p,a]);return{updateItemToPickupShipment:p,updateItemToDeliveryShipment:a,updateItemsToDeliveryShipment:l,updateItemsToPickupShipment:c,updateDeliveryOption:h}}},38446(t,e,n){n.d(e,{n:()=>I});var r=n(10939),i=n(28407),o=n(77810),s=n(90031),d=n(46508),u=n(18222),p=n(27869);const a=t=>{const e=(0,s.useShopperBasketsMutation)("createShipmentForBasket"),n=(0,s.useShopperBasketsMutation)("removeShipmentFromBasket"),r=(0,s.useShopperBasketsMutation)("updateShipmentForBasket"),d=(0,s.useShopperBasketsMutation)("updateShippingMethodForShipment"),a=(0,o.useCallback)(function(){var n=(0,i.A)(function*(n,r={}){if(null==t||!t.basketId)throw new Error("Missing basket or basketId");const i={shipmentId:`shipment_${(0,p.Ak)()}`};n&&(i.shippingAddress=(0,u.Nr)(n)),r.shippingMethodId&&(i.shippingMethod={id:r.shippingMethodId}),r.storeId&&(i.c_fromStoreId=r.storeId);const o=yield e.mutateAsync({parameters:{basketId:t.basketId},body:i});if(null==t||!t.shipments||null==o||!o.shipments)throw new Error("Unable to identify new shipment: missing basket or response shipments");const s=new Set(t.shipments.map(t=>t.shipmentId)),d=o.shipments.find(t=>!s.has(t.shipmentId));if(!d)throw new Error("Unable to identify new shipment: no new shipment found in response");return d});return function(t){return n.apply(this,arguments)}}(),[t,e]),l=(0,o.useCallback)(function(){var e=(0,i.A)(function*(e){if(null==t||!t.basketId||!e)throw new Error("Missing basket or shipmentId");yield n.mutateAsync({parameters:{basketId:t.basketId,shipmentId:e}})});return function(t){return e.apply(this,arguments)}}(),[t,n]),c=(0,o.useCallback)(function(){var e=(0,i.A)(function*(e,n){if(null==t||!t.basketId||!e||!n)throw new Error("Missing basket, shipmentId, or address");const i=(0,u.Nr)(n);return yield r.mutateAsync({parameters:{basketId:t.basketId,shipmentId:e},body:{shippingAddress:i}})});return function(t,n){return e.apply(this,arguments)}}(),[t,r]),h=(0,o.useCallback)(function(){var e=(0,i.A)(function*(e,n){if(null==t||!t.basketId||!e||!n)throw new Error("Missing basket, shipmentId, or shippingMethodId");return yield d.mutateAsync({parameters:{basketId:t.basketId,shipmentId:e},body:{id:n}})});return function(t,n){return e.apply(this,arguments)}}(),[t,d]);return{createShipment:a,removeShipment:l,updateShipmentAddress:c,updateShippingMethod:h}};var l=n(4997),c=n(73448),h=n(6834),f=n(2702);function m(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?m(Object(n),!0).forEach(function(e){(0,r.A)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):m(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}const I=t=>{const{getDefaultShippingMethodId:e,getPickupShippingMethodId:n,updateDefaultShipmentIfNeeded:r}=(0,d.i)(t),{createShipment:p,removeShipment:m,updateShipmentAddress:I,updateShippingMethod:v}=a(t),{updateItemsToDeliveryShipment:b,updateItemsToPickupShipment:k,updateDeliveryOption:g}=(0,l.A)(null==t?void 0:t.basketId),{refetch:S}=(0,s.useShippingMethodsForShipment)({parameters:{basketId:null==t?void 0:t.basketId,shipmentId:c.zQ}},{enabled:!1}),A=function(){var n=(0,i.A)(function*(){var n;if(null==t||!t.basketId||null==t||null===(n=t.shipments)||void 0===n||!n.length)return;const r=t.shipments.filter(t=>!t.shippingMethod);if(0!==r.length)try{const{data:t}=yield S(),n=e(t),o=r.map(function(){var t=(0,i.A)(function*(t){try{yield v(t.shipmentId,n)}catch(e){h.A.error(`Failed to assign shipping method to shipment ${t.shipmentId}`,{error:e.message,shipmentId:t.shipmentId,defaultShippingMethodId:n})}});return function(e){return t.apply(this,arguments)}}());yield Promise.all(o)}catch(e){h.A.error("Failed to fetch shipping methods",{error:e.message,basketId:null==t?void 0:t.basketId})}});return function(){return n.apply(this,arguments)}}(),w=function(){var t=(0,i.A)(function*(t){var e,n;return!(null===(e=t.shipments)||void 0===e?void 0:e.find(t=>t.shipmentId===c.zQ))||null!==(n=t.productItems)&&void 0!==n&&n.some(t=>t.shipmentId===c.zQ)?{shipments:[yield p()]}:yield r(t,c.zQ,!1)});return function(e){return t.apply(this,arguments)}}(),O=function(){var e=(0,i.A)(function*(){let e=(0,f.F_)(t);if(!e){var n;const r=yield w(t);e=null==r||null===(n=r.shipments)||void 0===n?void 0:n.find(t=>!(0,f.gF)(t.shippingMethod))}return e});return function(){return e.apply(this,arguments)}}(),M=function(){var e=(0,i.A)(function*(e){if(null==e||!e.id)throw new Error("No store selected for pickup");if(!e.inventoryId)throw new Error("Selected store does not have an inventory ID");let n=(0,f.Ln)(t,e.id);if(!n){var r;const i=yield P(t,e);n=null==i||null===(r=i.shipments)||void 0===r?void 0:r.find(t=>(0,f.gF)(t.shippingMethod)&&t.c_fromStoreId===e.id)}return n});return function(t){return e.apply(this,arguments)}}(),P=function(){var t=(0,i.A)(function*(t,e){var i,o;if((null===(i=t.shipments)||void 0===i?void 0:i.find(t=>t.shipmentId===c.zQ))&&(null===(o=t.productItems)||void 0===o||!o.some(t=>t.shipmentId===c.zQ)))return yield r(t,c.zQ,!0,e);const{data:s}=yield S(),d=n(s);if(!d)throw new Error("No pickup shipping method found");return{shipments:[{shipmentId:(yield p((0,u.T_)(e),{shippingMethodId:d,storeId:e.id})).shipmentId,shippingMethod:{id:d,c_storePickupEnabled:!0},c_fromStoreId:e.id}]}});return function(e,n){return t.apply(this,arguments)}}(),D=function(){var t=(0,i.A)(function*(t,e){return null!=t&&t.basketId&&e?yield p(e):null});return function(e,n){return t.apply(this,arguments)}}(),j=function(){var e=(0,i.A)(function*(e,n){return null!=t&&t.basketId&&e&&n?yield I(e,n):null});return function(t,n){return e.apply(this,arguments)}}(),E=function(){var t=(0,i.A)(function*(t,e,n,r){yield g(t,e,n,r,M,O)});return function(e,n,r,i){return t.apply(this,arguments)}}(),_=function(){var e=(0,i.A)(function*(e,n){let r=c.zQ;var i,o;return t&&(r=e?null===(i=yield M(n))||void 0===i?void 0:i.shipmentId:null===(o=yield O())||void 0===o?void 0:o.shipmentId),r});return function(t,n){return e.apply(this,arguments)}}(),Q=function(){var t=(0,i.A)(function*(t,e){try{return(0,f.gF)(t.shippingMethod)?yield z(t,e):yield F(t,e)}catch(e){return h.A.error(`Failed to consolidate shipment ${t.shipmentId}`,{error:e.message,shipmentId:t.shipmentId}),!1}});return function(e,n){return t.apply(this,arguments)}}(),z=function(){var e=(0,i.A)(function*(e,n){var i;const o=e.c_fromStoreId,s=null===(i=n[0])||void 0===i?void 0:i.inventoryId;if(!o||!s)return h.A.error("Missing store or inventory information for pickup consolidation"),!1;const d=y(y({},(0,u.Nr)(e.shippingAddress)),{},{name:e.shippingAddress.firstName,id:o,inventoryId:s});return yield r(t,c.zQ,!0,d),yield k(n,c.zQ,s),!0});return function(t,n){return e.apply(this,arguments)}}(),F=function(){var e=(0,i.A)(function*(e,n){var i;const o=null===(i=n[0])||void 0===i?void 0:i.inventoryId;return yield r(t,c.zQ,!1,null),yield j(c.zQ,e.shippingAddress),yield b(n,c.zQ,o),!0});return function(t,n){return e.apply(this,arguments)}}(),B=function(){var t=(0,i.A)(function*(t){try{return yield m(t),!0}catch(e){return h.A.error(`Failed to remove shipment ${t}:`,{error:e.message,shipmentId:t}),!1}});return function(e){return t.apply(this,arguments)}}(),C=function(){var t=(0,i.A)(function*(t){const e=t.map(t=>B(t.shipmentId));yield Promise.all(e)});return function(e){return t.apply(this,arguments)}}(),N=function(){var t=(0,i.A)(function*(t,e){if(!e.find(t=>t.shipmentId===c.zQ))return null;const n=(0,f.C7)(t);if(!n)return null;const r=(0,f.yp)(t,n.shipmentId);return 0===r.length?null:(yield Q(n,r))?(yield B(n.shipmentId),n.shipmentId):null});return function(e,n){return t.apply(this,arguments)}}(),T=function(){var t=(0,i.A)(function*(t){var e;if(null==t||!t.basketId||null==t||null===(e=t.shipments)||void 0===e||!e.length)return;const n=(0,f.YQ)(t);if(0===n.length)return;const r=yield N(t,n),i=n.filter(t=>t.shipmentId!==c.zQ&&t.shipmentId!==r);i.length>0&&(yield C(i))});return function(e){return t.apply(this,arguments)}}(),q=(0,o.useCallback)(function(){var e=(0,i.A)(function*(e,n,r,i){try{const s={};let d=null;e.forEach(e=>{var i;const o=n[e.itemId]||(null===(i=r[0])||void 0===i?void 0:i.addressId),d=r.find(t=>t.addressId===o),u=(0,f.Wf)(t,d);s[o]||(s[o]={address:d,items:[],shipmentId:null==u?void 0:u.shipmentId}),s[o].items.push(e)});for(const[e,n]of Object.entries(s)){const{address:r,items:u,shipmentId:p}=n;let a=p;if(!a){const e=(0,f.Oh)(t,Object.values(s).map(t=>t.shipmentId).filter(Boolean));if(a=null==e?void 0:e.shipmentId,a)yield j(a,r);else{const e=yield D(t,r);a=null==e?void 0:e.shipmentId}}s[e].shipmentId=a;const l=u.filter(t=>t.shipmentId!==a);if(l.length>0){var o;const t=l[0],e=null==i?void 0:i[t.productId],n=null==e||null===(o=e.inventory)||void 0===o?void 0:o.id;if(!n)throw new Error(`No inventory ID found for product ${t.productId}`);d=yield b(l,a,n)}}return yield T(d||t),{success:!0}}catch(t){throw new Error(`Failed to process shipments: ${t.message}`)}});return function(t,n,r,i){return e.apply(this,arguments)}}(),[t,D,j,b,T]);return{updateShipmentsWithoutMethods:A,updateDeliveryOption:E,removeEmptyShipments:T,createNewDeliveryShipment:w,createNewDeliveryShipmentWithAddress:D,createNewPickupShipment:P,findOrCreateDeliveryShipment:O,findOrCreatePickupShipment:M,getShipmentIdForItems:_,updateDeliveryAddressForShipment:j,orchestrateShipmentOperations:q}}},46508(t,e,n){n.d(e,{A:()=>c,i:()=>l});var r=n(10939),i=n(28407),o=n(90031),s=n(73448),d=n(18222),u=n(2702);function p(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function a(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?p(Object(n),!0).forEach(function(e){(0,r.A)(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}const l=t=>{const e=(0,o.useShopperBasketsMutation)("updateShipmentForBasket"),{refetch:n}=(0,o.useShippingMethodsForShipment)({parameters:{basketId:null==t?void 0:t.basketId,shipmentId:s.zQ}},{enabled:!1}),r=t=>{if(null==t||!t.applicableShippingMethods)return null;const e=t.applicableShippingMethods.find(t=>!0===t.c_storePickupEnabled);return(null==e?void 0:e.id)||null},p=t=>(null==t?void 0:t.defaultShippingMethodId)||null,l=function(){var t=(0,i.A)(function*(t,n,r={}){const i="005",{pickupShippingMethodId:o=i}=r;if(null!=n&&n.inventoryId)return yield e.mutateAsync({parameters:{basketId:t,shipmentId:s.zQ},body:{shippingMethod:{id:o},c_fromStoreId:n.id,shippingAddress:(0,d.T_)(n)}})});return function(e,n){return t.apply(this,arguments)}}(),c=function(){var t=(0,i.A)(function*(t,n){return yield e.mutateAsync({parameters:{basketId:t,shipmentId:s.zQ},body:{shippingMethod:{id:n},c_fromStoreId:null,shippingAddress:{}}})});return function(e,n){return t.apply(this,arguments)}}(),h=function(){var t=(0,i.A)(function*(t,e,i,o){var d;if(null==t||!t.basketId||null==t||null===(d=t.shipments)||void 0===d||!d.length||e!==s.zQ)return;const a=t.shipments.find(t=>t.shipmentId===e)||t.shipments[0],h=(0,u.f_)(a),f=a.c_fromStoreId;if(i!==h||h&&f!==o.id){const{data:e}=yield n();if(i){const n=r(e);return yield l(t.basketId,o,{pickupShippingMethodId:n})}{const n=p(e);return yield c(t.basketId,n)}}});return function(e,n,r,i){return t.apply(this,arguments)}}();return{updatePickupShipment:l,updateDeliveryShipment:c,updateDefaultShipmentIfNeeded:h,hasPickupItems:(t,e,n)=>t.some(t=>{const r=(t.variant||t.product||n).productId||(t.variant||t.product||n).id;return!!e[r]||e[null==n?void 0:n.id]}),addInventoryIdsToPickupItems:(t,e,n)=>null!=n&&n.inventoryId?t.map(t=>{const r=t.productId||t.id;return e[r]?a(a({},t),{},{inventoryId:n.inventoryId}):t}):t,getPickupShippingMethodId:r,getDefaultShippingMethodId:p,updateShipmentForBasketMutation:e}},c=l}}]);